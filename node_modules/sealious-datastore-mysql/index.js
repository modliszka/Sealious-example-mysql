//var Promise = require("bluebird");
var Sealious = require("sealious");
var Mysql = require("mysql");
//var DbsCommonPart = require('sealious-datastore-dbs-common-part');

var DatastoreMysql  = new Sealious.ChipTypes.Datastore("mysql");



DatastoreMysql.start = function(){
	var config = Sealious.ConfigManager.get_config("datastore_mysql");

	var mysql_client = Mysql.createConnection(config);
	mysql_client.connect();
	var db_name = "my_db";
	var sql_query = 'CREATE DATABASE IF NOT EXISTS ??';
	mysql_client.query(sql_query, [db_name], function(err, rows, fields) {
		if (err) throw err;
	});
	mysql_client.query('USE ??',[db_name], function(err, rows) {
		if (err) throw err;
	});


	var resource_types = Sealious.ChipManager.get_chips_by_type("resource_type");
	//console.log(resource_types.places.fields.name.type_name);

	for (var i in resource_types) {
		var rt = resource_types[i];
	//	console.log("mamy typ ", rt.name);
		var table_name = rt.name;
		var values = "("
		for (var irt in rt.fields) {
			console.log(rt.fields[irt].name," ", rt.fields[irt].type_name );
			values = values + (rt.fields[irt].name + " ");
			if (rt.fields[irt].type_name == "int") 
				values = values + "INT,"
			else if(rt.fields[irt].type_name == "float") 
				values = values + "FLOAT,"
			else 
				values = values + "VARCHAR(255),"
		}
		values = values.substring(0, values.length-1) + ")";
		console.log(values);
		mysql_client.query('CREATE TABLE IF NOT EXISTS ' +table_name +" "+values+';', function(err, rows, fields){
			if (err) throw err;
		});

/*
		sprawdzić czy istnieje tabela
			jesli tak, to sprawdź czy jest kolumna (show fields from places)
				jesli tak, to sprawdź jej typ
					jesli jest inny, to: (alter table_name modify column_name)
					 (tu musi być catch)
				jesli nie, to ją dodaj
			jesli nie, to utwórz: CREATE TABLE IF NOT EXISTS 

*/
	}

	
	mysql_client.query('show fields from places', function(err, rows, fields) {
		if (err) throw err;
		console.log('\n\n\nRows ', rows);
	});
	
	/*
[ { Field: 'name',
	Type: 'varchar(255)',
	Null: 'YES',
	Key: '',
	Default: null,
	Extra: '' },
	*/


	//mysql_client.end();
}




//DatastoreMysql = DbsCommonPart(DatastoreMysql,private);		

module.exports = DatastoreMysql;